(ns flocking.boid
  (:use [flocking.events]
	[flocking.protocols]
	[rosado.processing]))

;; (def *boid-counter* (ref 0))
(def *boid-radius*       20)

(defrecord Boid [id pos vel]
  Identifiable
  (id   [x] id)

  Particle
  (mass [x]   1)
  (pos  [x] pos)
  (vel  [x] vel)
  (acc  [x] acc)
  (dir  [x]
	(let [[x y] pos]
	  (Math/atan2 y x)))
  Radial
  (radius [x] *boid-radius*)

  Drawable
  (draw-obj [x]
	    (let [[xp yp] pos
		  rad (radius x)]
	      (with-translation [xp yp]
		(ellipse 0 0 r r)
		(with-rotation  [(dir x)]
		  (line 0 0 0 (* 2 r))
		  (with-translation [0 (* 2 r)]
		    (with-rotation [QUARTER_PI]
		      (line 0 0 0 (/ r 4)))
		    (with-rotation [(- QUARTER_PI)]
		      (line 0 0 0 (/ r 4)))))))))

(defn make-boid [id pos vel]
  (Boid. id pos vel))


;; (defn reset-boid-counter []
;;   (dosync (ref-set *boid-counter* 0)))